name: teof-pr-failure-handler
on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches: [main]
  push:
    branches: [main]
permissions:
  contents: read
  pull-requests: write
jobs:
  noop:
    if: ${{ github.event_name != 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "non-PR invocation: nothing to do"

  gate-docs:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Detect docs label
        id: flags
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request?.labels || [];
            const hasDocs = labels.some(label => label.name === 'auto-merge-docs');
            core.setOutput('has_docs_label', hasDocs ? 'true' : 'false');

      - uses: actions/checkout@v4
        if: steps.flags.outputs.has_docs_label == 'true'
        with: { fetch-depth: 0 }
      - name: Doctor (invariants-only)
        if: steps.flags.outputs.has_docs_label == 'true'
        id: doc
        run: |
          set -e
          # Your doctor should be fast & invariants-only by policy.
          tools/doctor.sh
      - name: On failure: stop auto-merge & explain
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            // Remove the auto-merge-docs label to halt automerge
            await github.rest.issues.removeLabel({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: pr.number, name: 'auto-merge-docs'
            }).catch(()=>{});
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: pr.number,
              body: "â›” Invariants failed (`tools/doctor.sh`). Auto-merge disabled. Please fix or close."
            });
