# Decentralized Receipt Sync Example

This example shows how to reproduce the synthetic multi-node reconciliation that backs the decentralized propagation pilot.

## Layout
- `datasets/samples/decentralized/` — two minimal node directories (`node-a`, `node-b`) with `_report/usage/` receipts, `governance/anchors.json`, and capsule metadata.
- `docs/examples/decentralized/receipt-sync/` — ledger, conflict listing, and summary generated by running `tools/network/receipt_sync.py` against the sample nodes.

## Re-run the sample
```bash
python3 -m tools.network.receipt_sync \
  --node node-a=datasets/samples/decentralized/node-a \
  --node node-b=datasets/samples/decentralized/node-b \
  --out-dir docs/examples/decentralized/receipt-sync \
  --expect _report/usage/external-summary.json \
  --expect _report/usage/receipts-hygiene-summary.json \
  --verify-anchor \
  --verify-capsule
```
The command overwrites `receipt-sync/` artifacts in place. They remain tracked for reproducibility.

Prefer a config file? Use `docs/examples/decentralized/receipt-sync/config.sample.json` as a template:
```bash
python3 -m tools.network.receipt_sync \
  --config docs/examples/decentralized/receipt-sync/config.sample.json \
  --out-dir docs/examples/decentralized/receipt-sync
```

## Integrating real nodes
1. Each steward clones the repo (or capsule) and runs their workflows, ensuring capsules and `_report` receipts are populated.
2. Export a snapshot per node (e.g., `rsync` the repo or mount a shared volume).
3. Run `tools/network/receipt_sync.py` with `--node` entries pointing to each snapshot.
4. Add `--expect` patterns for the receipts you want to require and use `--verify-signatures`/`--require-signatures` to enforce authenticity envelopes once feeds sign their outputs.
5. Inspect `summary.md` for conflicts, missing coverage, or signature failures. Attach `ledger.json` and supporting outputs to the relevant plan step before promoting decentralized properties into governance.

This keeps the pilot reproducible and gives maintainers a known-good baseline before expanding to live steward nodes.

## Discover nodes and auto-generate config
To scan a directory of TEOF checkouts and emit a config stub:
```bash
python3 -m tools.network.discover /path/to/nodes --expect '_report/usage/*.json' --out my-network.json
python3 -m tools.network.receipt_sync --config my-network.json --out-dir _report/network/<run>
```
The `discover` helper looks for `_report/` children, so you can point it at a parent folder or specific node directories.
