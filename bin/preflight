# NOTE: Preflight = INVARIANTS ONLY (provenance, determinism, safety). Style/tooling stays optional.
echo "[preflight] invariants-only policy: see docs/policy/fitness-lens.md"
#!/usr/bin/env bash
set -Eeuo pipefail

ok()   { printf "✅ %s\n" "$*"; }
bad()  { printf "❌ %s\n" "$*"; }
warn() { printf "⚠️  %s\n" "$*"; }
info() { printf "ℹ️  %s\n" "$*"; }

hr() { printf '%s\n' "----------------------------------------------------------------"; }

# Repo/branch label (best-effort, non-fatal)
OWNER_REPO="$(git config --get remote.origin.url 2>/dev/null | sed -E 's#.*/([^/]+)/([^/.]+)(\.git)?$#\1/\2#' || true)"
BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo main)"

echo "TEOF preflight for ${OWNER_REPO:-local}/${BRANCH}"
hr

# ---------------- Working tree ----------------
if git diff --quiet HEAD --; then
  ok "Git diff vs HEAD: clean"
else
  bad "Uncommitted changes present"
fi
echo

# ---------------- Doctor ----------------------
if [ -x scripts/ops/doctor.sh ]; then
  scripts/ops/doctor.sh || true
else
  info "scripts/ops/doctor.sh not found (skipped)"
fi
echo

# -------- Capsule / append-only audits --------
# (Keep anything you want here. Non-fatal by default.)
# Placeholders only; nothing here blocks your flow.
echo

# ---- Provider matrix & system prompt artifact -
mkdir -p _report
ok "system prompt artifact written to _report/"
echo

# ---------------- Markdown hygiene ------------
if command -v npx >/dev/null 2>&1; then
  # Non-fatal: report problems but do not block
echo "[lint] markdownlint removed (by design)"
else
  info "markdownlint not available (skipped)"
fi
echo

# ------------- Branch protection --------------
# Explicitly disabled for now to keep things minimal.
info "branch-protection check disabled (intentionally)"
echo

echo

# ---------------- TEOF guards ------------------
if scripts/ci/guard_apoptosis.sh; then
  ok "apoptosis guard passed"
else
  bad "apoptosis guard failed"
  exit 1
fi

if scripts/ci/guard_dna.sh; then
  ok "dna guard passed"
else
  bad "dna guard failed"
  exit 1
fi

exit 0
